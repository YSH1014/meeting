{% extends 'base.html' %}
{% block title %}
    {{ title }}
{% endblock %}
{% block content %}
    <style>
        .meeting-filter-navbar {
            margin-bottom: 0px;
        }

        .meeting-filterbox-navbrand {
            background-color: rgb(55, 84, 131);
            border-radius: 10px;
            padding: 5px 10px;
            font-size: 14px;
            color: #eee !important;
        }

        .meeting-filterbox-listitem {
            border-radius: 10px;
            line-height: 20px;
            padding: 0px 10px;
            margin: 5px 0px;
        }

        .meeting-filterbox-listitem:hover {
            background-color: #eee;
        }

    </style>
    <meta name="description" content="Filtrify">
    <meta name="keywords" content="javascript, jquery, filtering, filter, plugin"/>
    <meta name="author" content="Luís Almeida">

    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href={{ url_for('static',filename="u/css/style.css") }}>
    <link rel="stylesheet" href={{ url_for('static',filename="u/css/sunburst.css") }}>
    <link rel="stylesheet" href={{ url_for('static',filename="u/css/filtrify.css") }}>

    <script src="https://apps.bdimg.com/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src={{ url_for('static',filename="u/js/highlight.pack.js") }}></script>
    <script src={{ url_for('static',filename="u/js/script.js") }}></script>
    <script src={{ url_for('static',filename="u/js/filtrify.min.js") }}></script>
    <script>

        var filter = {
            "country": [],
            "city":[],
            "year": [],
            "month": [],
            "language":[]
        };

        window.onload = function(){

        };
        //退出时存储filter
        window.onbeforeunload = function(){
            localStorage.setItem("lastList",window.location.href);
            localStorage.setItem("filter",JSON.stringify(filter));
        };
        $(function () {
            var ft = $.filtrify("container", "placeHolder");



            $("#placeHolder").hide();//默认的这个隐藏了
            var filter_box = document.getElementById("filter-box");
            //var placeHolder = document.getElementById("placeHolder");
            //添加横向菜单
            for (filter_key in ft._fields) {
                //filter_key 值为country,year等
                var ul = document.createElement("ul");
                ul.className = "navbar-nav  meeting-search-menu ft-menu";
                //ul.style.margin = "20px 0px";
                //ul.style.textAlign = "center";
                var filter_values = ft._fields[filter_key];
                for (filter_value in ft._fields[filter_key]) {
                    //filter_value值为中国，2020等
                    var li = document.createElement("li");
                    var a = document.createElement("a");
                    li.className = "nav-item meeting-filterbox-listitem";
                    a.href = "#";
                    a.className = "filter-tag nav-link index-topNav-link";
                    var keyAttr = document.createAttribute("key");
                    keyAttr.value = filter_key;
                    a.setAttributeNode(keyAttr);
                    var valueAttr = document.createAttribute("value");
                    valueAttr.value = filter_value;
                    a.setAttributeNode(valueAttr);
                    a.innerHTML = filter_value;

                    li.appendChild(a);
                    ul.appendChild(li);
                }
                var nav = document.createElement("nav");
                nav.className = "navbar navbar-expand-sm meeting-filter-navbar navbar-default";
                //nav的成员之a
                var a = document.createElement("a");
                a.innerHTML = filter_key.toUpperCase();
                a.className = "navbar-brand meeting-filterbox-navbrand";
                //nav的成员之Button
                var button = document.createElement("button");
                button.className = "navbar-toggler";
                button.innerHTML = "&#9660;";
                //button.innerHTML = "展开";
                button.setAttribute("type", "button");
                button.setAttribute("data-toggle", "collapse");
                button.setAttribute("data-target", "#navbarDropdown" + filter_key);
                button.setAttribute("aria-controls", "navbarDropdown" + filter_key);
                button.setAttribute("aria-expanded", "false");
                button.setAttribute("aria-label", "Toggle navigation");
                //nav的成员之div
                var div = document.createElement("div");
                div.className = "collapse navbar-collapse";
                div.id = "navbarDropdown" + filter_key;
                div.appendChild(ul);

                nav.appendChild(a);
                nav.appendChild(button);
                nav.appendChild(div);
                filter_box.appendChild(nav);
            }
            //为横向菜单按钮添加动作
            $(".filter-tag").click(function () {
                //执行过滤
                var key = $(this).attr("key");
                var value = $(this).attr("value");
                filter[key] = [value];
                ft.trigger(filter);
                //修改颜色
                $(this).parent().siblings().children().css({"color": "black"});
                $(this).css({"color": "blue"});
            });
            $("#reset").click(function () {
                filter["country"] = [];
                filter["city"] = [];
                filter["language"] = [];
                filter["year"] = [];
                filter["month"] = [];
                ft.reset();
                $("a.filter-tag").css({color: "black"})
            })

            // 读取之前存储的filter
            var filter_stored = localStorage.getItem("filter");
            patt = '[key={key}][value={value}]';
            if (filter_stored != null){
                filter = JSON.parse(filter_stored);
                ft.trigger(filter);
                //重新替换颜色

                for(key in filter){
                    if(filter[key].length==1){
                        $(patt.replace("{key}",key).replace("{value}",filter[key][0])).css(
                            {
                                color:"blue"
                            }
                        )
                    }
                }
            }

        });

    </script>
    <div class="card meetings-card">
        <div class="card-header" style="text-align: center;"> 筛选会议</div>
        <div id="placeHolder"></div>
        <div id="filter-box"></div>
        <div align="center" style="margin-bottom: 15px;margin-top: 15px">
            <button id="reset" class="btn btn-sm btn-outline-danger" onclick="reset">重置条件</button>
        </div>

    </div>


    <div id="container">
        {% for meeting in meetings %}
            <div class="card meetings-card"
                 data-Year="{{ meeting.start_date.year }}"
                 data-Month="{{ meeting.start_date.month }}"
                 data-Country="{{ meeting.get_country() }}"
                 data-City="{{ meeting.city }}"
                 data-Language="{{ meeting.lang }}"
            >
                <div class="card-header" style="text-shadow: 2px 2px 2px #ffff00;">
                    {% if meeting.title %}
                        <strong>{{ meeting.title }}</strong>
                    {% endif %}
                    {% if meeting.title_EN %}
                        <p>{{ meeting.title_EN }}</p>
                    {% endif %}
                </div>
                <div class="card-body">
                    <blockquote class="blockquote mb-0">
                        <p class="meetings-title">{{ meeting.short_name }}</p>

                        <div class="row meetings-detail">
                            <div class="col-sm-1">日期</div>
                            <div class="col-sm-11">{{ meeting.start_date }} - {{ meeting.end_date }}</div>
                            <div class="col-sm-1">地点</div>
                            <div class="col-sm-11">{{ meeting.full_location() }}</div>
                            <div class="col-sm-1">Location</div>
                            <div class="col-sm-11">{{ meeting.full_location_EN() }}</div>
                            <div class="col-sm-1">官网</div>
                            <div class="col-sm-11"><a href="{{ meeting.url }}" target="_blank">{{ meeting.url }}</a>
                            </div>
                            <div class="col-sm-1">最近更新</div>
                            <div class="col-sm-11">{{ meeting.register_time.date() }}</div>
                        </div>
                    </blockquote>
                </div>
                <div class="card-footer text-muted meetings-more">
                    <a href="{{ url_for('meeting_detail',id=meeting.id) }}">更多详情</a>
                </div>
            </div>
        {% endfor %}
    </div>


{% endblock %}